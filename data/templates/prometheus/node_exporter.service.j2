{% set vrf_command = 'ip vrf exec ' ~ vrf ~ ' runuser -u node_exporter -- ' if vrf is vyos_defined else '' %}
[Unit]
Description=Node Exporter
Documentation=https://github.com/prometheus/node_exporter
After=network.target

[Service]
{% if vrf is not vyos_defined %}
User=node_exporter
{% endif %}
ExecStart={{ vrf_command }}/usr/sbin/node_exporter \
{% if collectors is vyos_defined %}
{%     if collectors.textfile is vyos_defined %}
        --collector.textfile.directory=/run/node_exporter/collector \
{%     endif %}
{% endif %}
{% if listen_address is vyos_defined %}
{%     for address in listen_address %}
        --web.listen-address={{ address | bracketize_ipv6 }}:{{ port }}
{%     endfor %}
{% else %}
        --web.listen-address=:{{ port }}
{% endif %}

[Install]
WantedBy=multi-user.target
