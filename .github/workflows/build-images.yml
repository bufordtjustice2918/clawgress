name: Build Clawgress Images

on:
  workflow_dispatch:
  schedule:
    # Nightly build at 2 AM UTC to track VyOS upstream
    - cron: '0 2 * * *'
  # push trigger disabled; use workflow_dispatch only

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout clawgress (vyos-1x fork)
        uses: actions/checkout@v4
        with:
          path: vyos-1x

      - name: Force system python3.10 before apt installs
        run: |
          if [ -x /usr/bin/python3.10 ]; then
            sudo ln -sf /usr/bin/python3.10 /usr/bin/python3
          fi
          python3 --version
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y --reinstall python3-apt && break || sleep 10; done
          /usr/bin/python3.10 -c "import apt_pkg; print('apt_pkg OK (early)')"

      - name: Configure Debian bookworm repo for newer live-build
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y gnupg ca-certificates && break || sleep 10; done
          sudo mkdir -p /usr/share/keyrings
          curl -fsSL https://ftp-master.debian.org/keys/archive-key-12.asc | sudo gpg --dearmor -o /usr/share/keyrings/debian-archive-keyring.gpg
          sudo tee /etc/apt/sources.list.d/debian-bookworm.list <<'EOF'
          deb [signed-by=/usr/share/keyrings/debian-archive-keyring.gpg] http://deb.debian.org/debian bookworm main
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm <<'EOF'
          Package: *
          Pin: release n=bookworm
          Pin-Priority: 100
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm-live-build <<'EOF'
          Package: live-build
          Pin: release n=bookworm
          Pin-Priority: 990
          EOF
          sudo tee /etc/apt/preferences.d/ubuntu-python3-apt <<'EOF'
          Package: python3-apt
          Pin: release o=Ubuntu
          Pin-Priority: 1001
          EOF

      - name: Install build dependencies
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y \
            git make curl sudo \
            build-essential \
            pbuilder devscripts equivs lsb-release libtool libapt-pkg-dev pkg-config debhelper \
            qemu-utils \
            python3 python3-venv python3-distutils \
            python3.11 python3.11-venv python3.11-dev \
            python3-pip python3-jinja2 python3-pystache python3-tomli python3-tomli-w python3-git python3-xmltodict python3-lxml python3-apt \
            libcrack2-dev \
            opam ocaml-findlib m4 \
            fakechroot \
            squashfs-tools genisoimage \
            gdisk sbsigntool dosfstools kpartx \
            cpio \
            syslinux grub2 grub-pc grub2-common \
            parted udev && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y -t bookworm debootstrap live-build && break || sleep 10; done

      - name: Ensure Ubuntu python3-apt is installed
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y --allow-downgrades -t jammy python3-apt && break || sleep 10; done

      - name: Ensure system python3 for apt_pkg
        run: |
          if [ -x /usr/bin/python3.10 ]; then
            sudo ln -sf /usr/bin/python3.10 /usr/bin/python3
          fi
          for i in 1 2 3 4 5; do sudo apt-get install -y --reinstall -t jammy python3-apt && break || sleep 10; done
          /usr/bin/python3.10 --version
          /usr/bin/python3.10 -c "import apt_pkg; print('apt_pkg OK')"

      - name: Use Python 3.11
        run: |
          # Keep system python3 pointing at distro version for apt/python-apt compatibility.
          python3 --version
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade psutil lxml

      - name: Reassert system python3 + python-apt
        run: |
          if [ -x /usr/bin/python3.10 ]; then
            sudo ln -sf /usr/bin/python3.10 /usr/bin/python3
          fi
          sudo apt-get install -y --reinstall -t jammy python3-apt
          /usr/bin/python3.10 --version
          /usr/bin/python3.10 -c "import apt_pkg; print('apt_pkg OK')"

      - name: Build vyos-1x package (cache generated by package build)
        run: |
          cd vyos-1x
          sudo apt-get update
          sudo apt-get install -y devscripts equivs
          sudo mk-build-deps -i -t "apt-get -y" debian/control
          dpkg-buildpackage -uc -us -b
          mkdir -p /tmp/aptrepo
          cp ../*.deb /tmp/aptrepo/
          (cd /tmp/aptrepo && dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz)

      - name: Install cracklib for Python 3.11
        run: |
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade --force-reinstall --no-binary :all: cracklib

      - name: Clone vyos-build
        run: |
          git clone https://github.com/vyos/vyos-build.git

      - name: Copy vyos-build modifications
        run: |
          # Copy build.conf to vyos-build
          cp vyos-1x/vyos-build-modifications/build.conf vyos-build/build.conf
          
          # Copy build flavor overrides (qcow2)
          mkdir -p vyos-build/data/build-flavors/
          cp vyos-1x/vyos-build-modifications/build-flavors/qcow2.toml vyos-build/data/build-flavors/

          # Copy chroot hooks
          mkdir -p vyos-build/data/live-build-config/hooks/live/
          mkdir -p vyos-build/data/live-build-config/hooks/chroot/
          mkdir -p vyos-build/data/live-build-config/hooks/normal/
          cp vyos-1x/vyos-build-modifications/50-clawgress-bind9.chroot vyos-build/data/live-build-config/hooks/live/
          cp vyos-1x/vyos-build-modifications/60-clawgress-init.chroot vyos-build/data/live-build-config/hooks/chroot/
          cp vyos-1x/vyos-build-modifications/60-clawgress-init.chroot vyos-build/data/live-build-config/hooks/normal/
          cp vyos-1x/vyos-build-modifications/60-clawgress-init.chroot vyos-build/data/live-build-config/hooks/live/
          cp vyos-1x/vyos-build-modifications/00-clawgress-dash-divert.chroot vyos-build/data/live-build-config/hooks/chroot/
          cp vyos-1x/vyos-build-modifications/00-clawgress-dash-divert.chroot vyos-build/data/live-build-config/hooks/normal/
          cp vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot vyos-build/data/live-build-config/hooks/chroot/
          cp vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot vyos-build/data/live-build-config/hooks/normal/
          cp vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot vyos-build/data/live-build-config/hooks/live/
          chmod +x vyos-build/data/live-build-config/hooks/live/50-clawgress-bind9.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/99-clawgress-force-bash.chroot
          
          # Copy policy.json to includes.chroot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          cp vyos-1x/vyos-build-modifications/config/clawgress/policy.json vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          # Also store default policy in /usr/share/clawgress for seeding /config on boot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/
          cp vyos-1x/vyos-build-modifications/config/clawgress/policy.json vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/policy.json

          # Copy Clawgress op-mode + helper scripts into image
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp vyos-1x/src/op_mode/clawgress.py vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          cp vyos-1x/src/helpers/clawgress-policy-apply.py vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          cp vyos-1x/src/helpers/clawgress-firewall-apply.py vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          # Config-mode handler
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp vyos-1x/src/conf_mode/clawgress.py vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp vyos-1x/src/utils/clawgress-policy-apply vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp vyos-1x/src/utils/clawgress-firewall-apply vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp vyos-1x/src/utils/clawgress vyos-build/data/live-build-config/includes.chroot/usr/bin/

          # Ensure Clawgress Vyatta templates are in squashfs
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/clawgress
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/clawgress
          cp -r vyos-1x/opt/vyatta/share/vyatta-cfg/templates/service/clawgress/* \
            vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/clawgress/
          cp -r vyos-1x/opt/vyatta/share/vyatta-op/templates/show/clawgress/* \
            vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/clawgress/

          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-policy-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-firewall-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-policy-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-firewall-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress
          
          echo "I: vyos-build modifications copied successfully"
          ls -la vyos-build/data/live-build-config/hooks/live/
          ls -la vyos-build/data/live-build-config/includes.chroot/config/clawgress/

      - name: Configure build
        run: |
          cd vyos-build
          # Point VYOS_SOURCE to the vyos-1x source tree
          # The build system will use this directly (no need to build .deb first)
          echo "VYOS_SOURCE=${{ github.workspace }}/vyos-1x" >> build.conf
          cat build.conf

      - name: Build ISO
        run: |
          cd vyos-build
          # Build with local vyos-1x source (packages will be picked up from VYOS_SOURCE)
          sudo ./build-vyos-image --build-by github-actions --architecture amd64 --build-type release --version clawgress generic \
            --custom-apt-entry "deb [trusted=yes] file:/tmp/aptrepo ./" \
            --custom-package vyos-1x
          ISO_FILE=$(ls -t build/*.iso | head -1)
          if [ -n "$ISO_FILE" ] && [ "$(basename "$ISO_FILE")" != "vyos-clawgress-generic-amd64.iso" ]; then
            ln -sf "$(basename "$ISO_FILE")" build/vyos-clawgress-generic-amd64.iso
          fi

      - name: Validate ISO contains Clawgress templates
        run: |
          ISO_FILE=$(ls -t vyos-build/build/*.iso | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "No ISO found"; exit 1; fi
          mkdir -p /tmp/iso_mnt /tmp/squash
          sudo mount -o loop "$ISO_FILE" /tmp/iso_mnt
          if [ ! -f /tmp/iso_mnt/live/filesystem.squashfs ]; then
            echo "Missing filesystem.squashfs"; sudo umount /tmp/iso_mnt; exit 1; fi
          sudo rm -rf /tmp/squash >/dev/null 2>&1 || true
          sudo unsquashfs -d /tmp/squash /tmp/iso_mnt/live/filesystem.squashfs >/dev/null
          sudo umount /tmp/iso_mnt
          test -d /tmp/squash/opt/vyatta/share/vyatta-cfg/templates/service/clawgress
          test -d /tmp/squash/opt/vyatta/share/vyatta-op/templates/show/clawgress
          test -d /tmp/squash/usr/share/vyos/templates/service/clawgress
          test -f /tmp/squash/usr/share/vyos/reftree.cache
          test -f /tmp/squash/usr/share/vyos/op_cache.json
          test -f /tmp/squash/usr/libexec/vyos/conf_mode/clawgress.py
          test -f /tmp/squash/usr/libexec/vyos/op_mode/clawgress.py
          test -f /tmp/squash/usr/libexec/vyos/clawgress-policy-apply.py
          test -f /tmp/squash/usr/libexec/vyos/clawgress-firewall-apply.py
          test -f /tmp/squash/usr/bin/clawgress
          test -f /tmp/squash/usr/bin/clawgress-policy-apply
          test -f /tmp/squash/usr/bin/clawgress-firewall-apply
          test -f /tmp/squash/usr/share/clawgress/policy.json
          test -d /tmp/squash/var/cache/bind
          test -d /tmp/squash/etc/bind/zones
          test -x /tmp/squash/usr/libexec/vyos/conf_mode/clawgress.py
          test -x /tmp/squash/usr/libexec/vyos/op_mode/clawgress.py
          echo "Clawgress templates present in ISO"

      - name: Remove live-build ISO
        run: |
          sudo rm -f vyos-build/build/live-image-*.iso

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clawgress-images
          path: |
            vyos-build/build/*.iso
          retention-days: 7

  smoke-test:
    name: Smoke Test ISO
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: clawgress-images
          path: ./artifacts

      - name: Install QEMU + squashfs tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils squashfs-tools

      - name: Find ISO and verify
        run: |
          ISO_PATH=$(find ./artifacts -name "*.iso" -type f | head -1)
          if [ -z "$ISO_PATH" ]; then
            echo "❌ ERROR: No ISO file found in artifacts"
            exit 1
          fi
          echo "iso_path=$ISO_PATH" >> $GITHUB_ENV
          echo "ISO found: $ISO_PATH"
          ls -lh "$ISO_PATH"

      - name: Boot ISO in QEMU and run smoke tests
        run: |
          set -e
          ISO_PATH="${{ env.iso_path }}"
          
          echo "====================================="
          echo "Starting QEMU smoke test"
          echo "====================================="
          
          # Create serial output log
          SERIAL_LOG=$(mktemp)
          echo "Serial log: $SERIAL_LOG"
          
          # Start QEMU with headless mode and serial console
          # Using virtio for network and disk, 2GB RAM, 2 CPUs
          # Note: -nographic implies -serial stdio, don't add explicit -serial
          qemu-system-x86_64 \
            -name clawgress-smoke-test \
            -m 2048 \
            -smp 2 \
            -boot d \
            -cdrom "$ISO_PATH" \
            -nographic \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -device virtio-net-pci,netdev=net0 \
            -drive file=/dev/null,format=raw,if=virtio \
            > "$SERIAL_LOG" 2>&1 &
          
          QEMU_PID=$!
          echo "QEMU PID: $QEMU_PID"
          
          # Wait for VM to boot (look for login prompt or key indicators)
          echo "Waiting for VM to boot (timeout: 5 minutes)..."
          BOOT_TIMEOUT=300
          ELAPSED=0
          BOOT_COMPLETE=false
          
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            sleep 5
            ELAPSED=$((ELAPSED + 5))
            
            if grep -q "login:" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "vyos@" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "Welcome to VyOS" "$SERIAL_LOG" 2>/dev/null; then
              echo "✓ Boot completed (login prompt detected)"
              BOOT_COMPLETE=true
              break
            fi
            
            if ! kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ QEMU process exited early"
              break
            fi
          done
          
          if [ "$BOOT_COMPLETE" != "true" ]; then
            if kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ Boot prompt not detected within timeout, but QEMU is still running. Proceeding with smoke tests."
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              BOOT_COMPLETE=true
            else
              echo "❌ ERROR: Boot did not complete within timeout"
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              kill $QEMU_PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          echo ""
          echo "====================================="
          echo "Running smoke tests"
          echo "====================================="
          
          # Give VM a moment to fully initialize
          sleep 5
          
          TESTS_PASSED=0
          TESTS_FAILED=0
          
          # Test 1: Check boot log for version info
          echo ""
          echo "Test 1: Checking version info in boot log..."
          if grep -iE "(vyos|version|1\.5|clawgress)" "$SERIAL_LOG" > /dev/null; then
            echo "  ✓ Version info found in boot log"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "  ⚠ Version info not clearly visible in boot log (non-fatal)"
          fi
          
          # Mount the ISO to inspect its contents
          echo ""
          echo "Test 2: Checking ISO contents for bind9 package..."
          MOUNT_DIR=$(mktemp -d)
          sudo mount -o loop "$ISO_PATH" "$MOUNT_DIR" || {
            echo "  ⚠ Could not mount ISO for inspection"
          }
          
          if [ -d "$MOUNT_DIR" ] && mountpoint -q "$MOUNT_DIR"; then
            # Look for bind9 in the squashfs or package lists
            if find "$MOUNT_DIR" -name "*.squashfs" -o -name "*.packages" 2>/dev/null | head -1 | grep -q .; then
              echo "  ✓ Found squashfs/packages in ISO"
              TESTS_PASSED=$((TESTS_PASSED + 1))
            else
              echo "  ⚠ Could not locate package files in ISO"
            fi
            
            # Check for clawgress-specific files
            echo ""
            echo "Test 3: Checking for clawgress files..."
            
            # Try to extract and inspect the filesystem
            SQUASHFS=$(find "$MOUNT_DIR" -name "*.squashfs" | head -1)
            if [ -n "$SQUASHFS" ]; then
              EXTRACT_DIR=$(mktemp -d)
              sudo unsquashfs -f -d "$EXTRACT_DIR" "$SQUASHFS" 2>/dev/null || true
              
              if [ -f "$EXTRACT_DIR/config/clawgress/policy.json" ]; then
                echo "  ✓ clawgress policy.json exists"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress policy.json NOT found"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -d "$EXTRACT_DIR/opt/vyatta/share/vyatta-cfg/templates/service/clawgress" ] && \
                 [ -d "$EXTRACT_DIR/opt/vyatta/share/vyatta-op/templates/show/clawgress" ] && \
                 [ -d "$EXTRACT_DIR/usr/share/vyos/templates/service/clawgress" ]; then
                echo "  ✓ clawgress templates present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress templates missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -f "$EXTRACT_DIR/usr/share/vyos/reftree.cache" ] && \
                 [ -f "$EXTRACT_DIR/usr/share/vyos/op_cache.json" ]; then
                echo "  ✓ vyos xml caches present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ vyos xml caches missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -x "$EXTRACT_DIR/usr/libexec/vyos/conf_mode/clawgress.py" ] && \
                 [ -x "$EXTRACT_DIR/usr/libexec/vyos/op_mode/clawgress.py" ]; then
                echo "  ✓ clawgress handlers present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress handlers missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -f "$EXTRACT_DIR/usr/bin/clawgress" ] && \
                 [ -f "$EXTRACT_DIR/usr/bin/clawgress-policy-apply" ] && \
                 [ -f "$EXTRACT_DIR/usr/bin/clawgress-firewall-apply" ]; then
                echo "  ✓ clawgress cli utils present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress cli utils missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -f "$EXTRACT_DIR/usr/share/clawgress/policy.json" ]; then
                echo "  ✓ clawgress default policy present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress default policy missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi

              if [ -d "$EXTRACT_DIR/var/cache/bind" ] && \
                 [ -d "$EXTRACT_DIR/etc/bind/zones" ]; then
                echo "  ✓ bind9 runtime dirs present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ bind9 runtime dirs missing"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi
              
              if [ -f "$EXTRACT_DIR/usr/share/vyos/config.boot.default" ] || \
                 [ -f "$EXTRACT_DIR/opt/vyatta/etc/config.boot.default" ]; then
                echo "  ✓ VyOS config files present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              fi
              
              # Check for bind9 package
              if [ -f "$EXTRACT_DIR/var/lib/dpkg/status" ]; then
                if grep -q "^Package: bind9" "$EXTRACT_DIR/var/lib/dpkg/status"; then
                  echo "  ✓ bind9 package is installed"
                  TESTS_PASSED=$((TESTS_PASSED + 1))
                else
                  echo "  ✗ bind9 package NOT found"
                  TESTS_FAILED=$((TESTS_FAILED + 1))
                fi
              elif [ -d "$EXTRACT_DIR/usr/sbin" ] && [ -f "$EXTRACT_DIR/usr/sbin/named" ]; then
                echo "  ✓ named binary found (bind9 installed)"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ⚠ bind9 package status could not be verified"
              fi
              
              # Cleanup
              sudo rm -rf "$EXTRACT_DIR" 2>/dev/null || true
            fi
            
            sudo umount "$MOUNT_DIR" 2>/dev/null || true
          fi
          
          rmdir "$MOUNT_DIR" 2>/dev/null || true
          
          # Stop QEMU
          echo ""
          echo "Shutting down QEMU..."
          kill $QEMU_PID 2>/dev/null || true
          wait $QEMU_PID 2>/dev/null || true
          
          # Cleanup
          rm -f "$SERIAL_LOG"
          
          # Report results
          echo ""
          echo "====================================="
          echo "SMOKE TEST RESULTS"
          echo "====================================="
          echo "Tests Passed: $TESTS_PASSED"
          echo "Tests Failed: $TESTS_FAILED"
          echo ""
          
          if [ $TESTS_FAILED -gt 0 ]; then
            echo "❌ SMOKE TEST FAILED"
            exit 1
          else
            echo "✅ SMOKE TEST PASSED"
            exit 0
          fi

      - name: Upload smoke test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            /tmp/serial-*
            ./artifacts
