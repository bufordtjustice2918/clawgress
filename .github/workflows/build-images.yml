name: Build Clawgress Images

on:
  workflow_dispatch:
    inputs:
      iso_version:
        description: ISO version label passed to build-vyos-image
        required: true
        default: clawgress-mvpv2
      publish_release:
        description: Publish ISO + checksums as a GitHub release
        required: true
        default: false
        type: boolean
      release_tag:
        description: Git tag for release (required if publish_release=true)
        required: false
        default: ""
  schedule:
    # Nightly build at 2 AM UTC to track VyOS upstream
    - cron: '0 2 * * *'
  # push trigger disabled; use workflow_dispatch only

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: vyos/vyos-build:current
      options: --privileged
    defaults:
      run:
        shell: bash
    outputs:
      artifact_name: ${{ steps.artifact_meta.outputs.artifact_name }}
      iso_version: ${{ steps.iso_version.outputs.iso_version }}
    steps:
      - name: Checkout clawgress (vyos-1x fork)
        uses: actions/checkout@v4
        with:
          path: vyos-1x

      - name: Resolve ISO version
        id: iso_version
        run: |
          if [ -n "${{ inputs.iso_version }}" ]; then
            echo "iso_version=${{ inputs.iso_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "iso_version=clawgress-nightly-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Clone vyos-build
        run: |
          git clone https://github.com/vyos/vyos-build.git

      - name: Copy vyos-build modifications
        run: |
          set -euxo pipefail
          SRC_ROOT="${GITHUB_WORKSPACE}/vyos-1x"

          # Copy build.conf to vyos-build and point source at checked out tree.
          cp "${SRC_ROOT}/vyos-build-modifications/build.conf" vyos-build/build.conf
          sed -i "s|^VYOS_SOURCE=.*|VYOS_SOURCE=${GITHUB_WORKSPACE}/vyos-1x|" vyos-build/build.conf
          
          # Copy build flavor overrides (qcow2)
          mkdir -p vyos-build/data/build-flavors/
          cp "${SRC_ROOT}/vyos-build-modifications/build-flavors/qcow2.toml" vyos-build/data/build-flavors/

          # Copy chroot hooks
          mkdir -p vyos-build/data/live-build-config/hooks/live/
          mkdir -p vyos-build/data/live-build-config/hooks/chroot/
          mkdir -p vyos-build/data/live-build-config/hooks/normal/
          cp "${SRC_ROOT}/vyos-build-modifications/50-clawgress-bind9.chroot" vyos-build/data/live-build-config/hooks/live/
          cp "${SRC_ROOT}/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${SRC_ROOT}/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${SRC_ROOT}/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/live/
          cp "${SRC_ROOT}/vyos-build-modifications/00-clawgress-dash-divert.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${SRC_ROOT}/vyos-build-modifications/00-clawgress-dash-divert.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${SRC_ROOT}/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${SRC_ROOT}/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${SRC_ROOT}/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/live/
          chmod +x vyos-build/data/live-build-config/hooks/live/50-clawgress-bind9.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/99-clawgress-force-bash.chroot
          
          # Copy policy.json to includes.chroot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          cp "${SRC_ROOT}/vyos-build-modifications/config/clawgress/policy.json" vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          # Also store default policy in /usr/share/clawgress for seeding /config on boot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/
          cp "${SRC_ROOT}/vyos-build-modifications/config/clawgress/policy.json" vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/policy.json

          # Copy Clawgress Python handlers + helper scripts into image.
          # Also copy XML definitions to ensure MVP CLI/op-mode definitions are present.
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/services/api/rest/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/templates/https/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/bin/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op-mode-definitions/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/interface-definitions/
          cp "${SRC_ROOT}/src/op_mode/clawgress.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          cp "${SRC_ROOT}/src/helpers/clawgress-policy-apply.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          cp "${SRC_ROOT}/src/helpers/clawgress-firewall-apply.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          # Config-mode handler
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp "${SRC_ROOT}/src/conf_mode/clawgress.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp "${SRC_ROOT}/src/utils/clawgress-policy-apply" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${SRC_ROOT}/src/utils/clawgress-firewall-apply" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${SRC_ROOT}/src/utils/clawgress" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${SRC_ROOT}/src/services/api/rest/routers.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/services/api/rest/routers.py
          cp "${SRC_ROOT}/src/services/api/rest/models.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/services/api/rest/models.py
          cp "${SRC_ROOT}/data/templates/https/nginx.default.j2" vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/templates/https/nginx.default.j2
          cp "${SRC_ROOT}/op-mode-definitions/show-clawgress.xml.in" vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op-mode-definitions/show-clawgress.xml.in
          cp "${SRC_ROOT}/interface-definitions/service_clawgress.xml.in" vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/interface-definitions/service_clawgress.xml.in
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-policy-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-firewall-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-policy-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-firewall-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress

          # Stage a late-overlay payload so Clawgress files are re-applied after
          # package install hooks and cannot be clobbered by build ordering.
          OVERLAY_ROOT="vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay"
          mkdir -p "${OVERLAY_ROOT}/usr/libexec/vyos/op_mode/"
          mkdir -p "${OVERLAY_ROOT}/usr/libexec/vyos/conf_mode/"
          mkdir -p "${OVERLAY_ROOT}/usr/libexec/vyos/"
          mkdir -p "${OVERLAY_ROOT}/usr/libexec/vyos/services/api/rest/"
          mkdir -p "${OVERLAY_ROOT}/usr/share/vyos/templates/https/"
          mkdir -p "${OVERLAY_ROOT}/usr/bin/"
          mkdir -p "${OVERLAY_ROOT}/usr/share/vyos/op-mode-definitions/"
          mkdir -p "${OVERLAY_ROOT}/usr/share/vyos/interface-definitions/"
          cp "${SRC_ROOT}/src/op_mode/clawgress.py" "${OVERLAY_ROOT}/usr/libexec/vyos/op_mode/"
          cp "${SRC_ROOT}/src/conf_mode/clawgress.py" "${OVERLAY_ROOT}/usr/libexec/vyos/conf_mode/"
          cp "${SRC_ROOT}/src/helpers/clawgress-policy-apply.py" "${OVERLAY_ROOT}/usr/libexec/vyos/"
          cp "${SRC_ROOT}/src/helpers/clawgress-firewall-apply.py" "${OVERLAY_ROOT}/usr/libexec/vyos/"
          cp "${SRC_ROOT}/src/utils/clawgress-policy-apply" "${OVERLAY_ROOT}/usr/bin/"
          cp "${SRC_ROOT}/src/utils/clawgress-firewall-apply" "${OVERLAY_ROOT}/usr/bin/"
          cp "${SRC_ROOT}/src/utils/clawgress" "${OVERLAY_ROOT}/usr/bin/"
          cp "${SRC_ROOT}/src/services/api/rest/routers.py" "${OVERLAY_ROOT}/usr/libexec/vyos/services/api/rest/routers.py"
          cp "${SRC_ROOT}/src/services/api/rest/models.py" "${OVERLAY_ROOT}/usr/libexec/vyos/services/api/rest/models.py"
          cp "${SRC_ROOT}/data/templates/https/nginx.default.j2" "${OVERLAY_ROOT}/usr/share/vyos/templates/https/nginx.default.j2"
          cp "${SRC_ROOT}/op-mode-definitions/show-clawgress.xml.in" "${OVERLAY_ROOT}/usr/share/vyos/op-mode-definitions/show-clawgress.xml.in"
          cp "${SRC_ROOT}/interface-definitions/service_clawgress.xml.in" "${OVERLAY_ROOT}/usr/share/vyos/interface-definitions/service_clawgress.xml.in"
          chmod +x "${OVERLAY_ROOT}/usr/libexec/vyos/op_mode/clawgress.py"
          chmod +x "${OVERLAY_ROOT}/usr/libexec/vyos/conf_mode/clawgress.py"
          chmod +x "${OVERLAY_ROOT}/usr/libexec/vyos/clawgress-policy-apply.py"
          chmod +x "${OVERLAY_ROOT}/usr/libexec/vyos/clawgress-firewall-apply.py"
          chmod +x "${OVERLAY_ROOT}/usr/bin/clawgress-policy-apply"
          chmod +x "${OVERLAY_ROOT}/usr/bin/clawgress-firewall-apply"
          chmod +x "${OVERLAY_ROOT}/usr/bin/clawgress"
          
          echo "I: vyos-build modifications copied successfully"
          ls -la vyos-build/data/live-build-config/hooks/live/
          ls -la vyos-build/data/live-build-config/includes.chroot/config/clawgress/

      - name: Build vyos-1x package
        run: |
          cd vyos-1x
          dpkg-buildpackage -uc -us -b
          mkdir -p /opt/aptrepo
          cp ../*.deb /opt/aptrepo/
          (cd /opt/aptrepo && dpkg-scanpackages . /dev/null > Packages)
          (cd /opt/aptrepo && gzip -9c Packages > Packages.gz)

      - name: Extract generated XML caches from vyos-1x package
        run: |
          set -euxo pipefail
          DEB_FILE="$(ls -1t /opt/aptrepo/vyos-1x_*_*.deb | head -1)"
          EXTRACT_DIR="vyos-1x/data/generated-cache"
          rm -rf "${EXTRACT_DIR}"
          mkdir -p "${EXTRACT_DIR}"
          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "${TMPDIR}"' EXIT
          dpkg-deb -x "${DEB_FILE}" "${TMPDIR}"

          require_copy() {
            src="$1"
            dst="$2"
            if [ ! -f "${src}" ]; then
              echo "ERROR: Missing required artifact: ${src}"
              exit 1
            fi
            cp "${src}" "${dst}"
          }

          optional_copy() {
            src="$1"
            dst="$2"
            if [ -f "${src}" ]; then
              cp "${src}" "${dst}"
            else
              echo "WARN: Optional artifact missing: ${src}"
            fi
          }

          require_copy "${TMPDIR}/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/vyos_1x_cache.py" "${EXTRACT_DIR}/vyos_1x_cache.py"
          require_copy "${TMPDIR}/usr/share/vyos/reftree.cache" "${EXTRACT_DIR}/reftree.cache"
          require_copy "${TMPDIR}/usr/share/vyos/op_cache.json" "${EXTRACT_DIR}/op_cache.json"
          optional_copy "${TMPDIR}/usr/lib/python3/dist-packages/vyos/xml_ref/cache.py" "${EXTRACT_DIR}/cache.py"
          optional_copy "${TMPDIR}/usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py" "${EXTRACT_DIR}/op_cache.py"

      - name: Verify generated Clawgress op templates and cache
        run: |
          set -euxo pipefail
          test -d vyos-1x/templates-cfg/service/clawgress
          test -f vyos-1x/templates-cfg/service/clawgress/node.def
          test -d vyos-1x/templates-op/show/clawgress
          test -f vyos-1x/templates-op/show/clawgress/status/node.def
          test -f vyos-1x/data/generated-cache/reftree.cache
          test -f vyos-1x/data/generated-cache/op_cache.json
          test -f vyos-1x/data/generated-cache/vyos_1x_cache.py
          grep -q 'clawgress' vyos-1x/data/generated-cache/vyos_1x_cache.py
          grep -q 'clawgress' vyos-1x/data/generated-cache/op_cache.json

      - name: Overlay generated Clawgress templates/cache into image
        run: |
          set -euxo pipefail
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-cfg/templates/service/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-op/templates/show/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-op/templates/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/share/vyos/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/
          cp -r vyos-1x/templates-cfg/service/clawgress vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/
          cp -r vyos-1x/templates-op/show/clawgress vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/
          if [ -d vyos-1x/templates-op/clawgress ]; then
            cp -r vyos-1x/templates-op/clawgress vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/
          fi
          cp vyos-1x/data/generated-cache/reftree.cache vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/reftree.cache
          cp vyos-1x/data/generated-cache/op_cache.json vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op_cache.json
          cp vyos-1x/data/generated-cache/vyos_1x_cache.py vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/
          if [ -f vyos-1x/data/generated-cache/cache.py ]; then
            cp vyos-1x/data/generated-cache/cache.py vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/cache.py
          fi
          if [ -f vyos-1x/data/generated-cache/op_cache.py ]; then
            cp vyos-1x/data/generated-cache/op_cache.py vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py
          fi

          # Copy generated templates/cache into late-overlay payload as well.
          cp -r vyos-1x/templates-cfg/service/clawgress vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-cfg/templates/service/
          cp -r vyos-1x/templates-op/show/clawgress vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-op/templates/show/
          if [ -d vyos-1x/templates-op/clawgress ]; then
            cp -r vyos-1x/templates-op/clawgress vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/opt/vyatta/share/vyatta-op/templates/
          fi
          cp vyos-1x/data/generated-cache/reftree.cache vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/share/vyos/reftree.cache
          cp vyos-1x/data/generated-cache/op_cache.json vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/share/vyos/op_cache.json
          cp vyos-1x/data/generated-cache/vyos_1x_cache.py vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/
          if [ -f vyos-1x/data/generated-cache/cache.py ]; then
            cp vyos-1x/data/generated-cache/cache.py vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/lib/python3/dist-packages/vyos/xml_ref/cache.py
          fi
          if [ -f vyos-1x/data/generated-cache/op_cache.py ]; then
            cp vyos-1x/data/generated-cache/op_cache.py vyos-build/data/live-build-config/includes.chroot/opt/clawgress-overlay/usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py
          fi

          test -d vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/clawgress
          test -d vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/clawgress
          test -f vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/reftree.cache
          test -f vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op_cache.json
          test -f vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/pkg_cache/vyos_1x_cache.py
          test -f vyos-build/data/live-build-config/includes.chroot/usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py

          # Finalize hook to force-overlay Clawgress payload after package install.
          mkdir -p vyos-build/data/live-build-config/hooks/normal
          cat > vyos-build/data/live-build-config/hooks/normal/98-clawgress-finalize.chroot <<'EOF'
          #!/bin/sh
          set -eu
          OVERLAY_ROOT=/opt/clawgress-overlay
          if [ ! -d "${OVERLAY_ROOT}" ]; then
            echo "ERROR: Missing ${OVERLAY_ROOT}"
            exit 1
          fi

          cp -a "${OVERLAY_ROOT}/." /

          test -f /usr/libexec/vyos/op_mode/clawgress.py
          test -f /usr/libexec/vyos/conf_mode/clawgress.py
          test -f /usr/libexec/vyos/services/api/rest/routers.py
          test -f /usr/libexec/vyos/services/api/rest/models.py
          test -f /usr/share/vyos/templates/https/nginx.default.j2
          test -d /opt/vyatta/share/vyatta-op/templates/show/clawgress
          test -d /opt/vyatta/share/vyatta-cfg/templates/service/clawgress
          test -f /usr/share/vyos/op_cache.json
          test -f /usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py
          grep -q "clawgress/health" /usr/libexec/vyos/services/api/rest/routers.py
          grep -q "class ClawgressPolicyModel" /usr/libexec/vyos/services/api/rest/models.py
          grep -q "renew|clawgress" /usr/share/vyos/templates/https/nginx.default.j2
          # Rebuild merged config cache from pkg_cache modules after overlay.
          # This avoids stale cache.py when only vyos_1x_cache.py is overlaid.
          python3 /usr/lib/python3/dist-packages/vyos/xml_ref/update_cache.py
          test -f /usr/lib/python3/dist-packages/vyos/xml_ref/cache.py
          grep -q 'clawgress' /usr/lib/python3/dist-packages/vyos/xml_ref/cache.py
          grep -q 'clawgress' /usr/lib/python3/dist-packages/vyos/xml_ref/op_cache.py
          grep -q 'clawgress' /usr/share/vyos/op_cache.json
          EOF
          chmod +x vyos-build/data/live-build-config/hooks/normal/98-clawgress-finalize.chroot

      - name: Sync local apt repo into chroot
        run: |
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/aptrepo
          cp -r /opt/aptrepo/* vyos-build/data/live-build-config/includes.chroot/opt/aptrepo/
          (cd vyos-build/data/live-build-config/includes.chroot/opt/aptrepo && dpkg-scanpackages . /dev/null > Packages)
          (cd vyos-build/data/live-build-config/includes.chroot/opt/aptrepo && gzip -9c Packages > Packages.gz)

          mkdir -p vyos-build/data/live-build-config/hooks/normal
          cat > vyos-build/data/live-build-config/hooks/normal/90-install-vyos-1x.chroot <<'EOF'
          #!/bin/sh
          set -e
          if ls /opt/aptrepo/*.deb >/dev/null 2>&1; then
            dpkg -i /opt/aptrepo/*.deb || apt-get -f install -y
          else
            echo "No local vyos-1x .deb found in /opt/aptrepo"
            exit 1
          fi
          EOF
          chmod +x vyos-build/data/live-build-config/hooks/normal/90-install-vyos-1x.chroot

      - name: Configure build
        run: |
          cd vyos-build
          cat build.conf

      - name: Build ISO
        run: |
          cd vyos-build
          # Build with local vyos-1x source (packages will be picked up from VYOS_SOURCE)
          sudo ./build-vyos-image --build-by github-actions --architecture amd64 --build-type release --version "${{ steps.iso_version.outputs.iso_version }}" generic
          ISO_FILE=$(ls -t build/*.iso | head -1)
          if [ -n "$ISO_FILE" ] && [ "$(basename "$ISO_FILE")" != "vyos-clawgress-generic-amd64.iso" ]; then
            sudo ln -sf "$(basename "$ISO_FILE")" build/vyos-clawgress-generic-amd64.iso
          fi

      - name: Verify Clawgress runtime files inside built ISO
        run: |
          set -euxo pipefail
          cd vyos-build
          if ! command -v unsquashfs >/dev/null 2>&1 || ! command -v bsdtar >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y squashfs-tools libarchive-tools
          fi

          ISO_FILE=$(ls -t build/*.iso | head -1)
          WORKDIR="$(mktemp -d)"
          trap 'rm -rf "${WORKDIR}"' EXIT
          bsdtar -xf "${ISO_FILE}" -C "${WORKDIR}" live/filesystem.squashfs
          SQ="${WORKDIR}/live/filesystem.squashfs"
          SQ_LIST="${WORKDIR}/squashfs.list"
          unsquashfs -lln "${SQ}" > "${SQ_LIST}"

          grep -q 'squashfs-root/usr/libexec/vyos/op_mode/clawgress.py' "${SQ_LIST}"
          grep -q 'squashfs-root/usr/libexec/vyos/conf_mode/clawgress.py' "${SQ_LIST}"
          grep -q 'squashfs-root/usr/libexec/vyos/services/api/rest/routers.py' "${SQ_LIST}"
          grep -q 'squashfs-root/usr/libexec/vyos/services/api/rest/models.py' "${SQ_LIST}"
          grep -q 'squashfs-root/usr/share/vyos/templates/https/nginx.default.j2' "${SQ_LIST}"
          grep -q 'squashfs-root/opt/vyatta/share/vyatta-op/templates/show/clawgress' "${SQ_LIST}"
          grep -q 'squashfs-root/opt/vyatta/share/vyatta-cfg/templates/service/clawgress' "${SQ_LIST}"
          grep -q 'squashfs-root/usr/share/vyos/op_cache.json' "${SQ_LIST}"
          unsquashfs -cat "${SQ}" /usr/share/vyos/op_cache.json | grep -q 'clawgress'
          unsquashfs -cat "${SQ}" /usr/libexec/vyos/services/api/rest/routers.py | grep -q 'clawgress/health'
          unsquashfs -cat "${SQ}" /usr/share/vyos/templates/https/nginx.default.j2 | grep -q 'renew|clawgress'

      - name: Remove live-build ISO
        run: |
          sudo rm -f vyos-build/build/live-image-*.iso

      - name: Generate checksums
        run: |
          cd vyos-build/build
          sudo sh -c 'sha256sum *.iso > SHA256SUMS'

      - name: Compute artifact metadata
        id: artifact_meta
        run: |
          echo "artifact_name=clawgress-images-${{ steps.iso_version.outputs.iso_version }}-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_meta.outputs.artifact_name }}
          path: |
            vyos-build/build/*.iso
            vyos-build/build/SHA256SUMS
          retention-days: 7

  smoke-test:
    name: Smoke Test ISO
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./artifacts

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils

      - name: Find ISO and verify
        run: |
          ISO_PATH=$(find ./artifacts -name "*.iso" -type f | head -1)
          if [ -z "$ISO_PATH" ]; then
            echo "❌ ERROR: No ISO file found in artifacts"
            exit 1
          fi
          echo "iso_path=$ISO_PATH" >> $GITHUB_ENV
          echo "ISO found: $ISO_PATH"
          ls -lh "$ISO_PATH"

      - name: Boot ISO in QEMU and run smoke tests
        run: |
          set -e
          ISO_PATH="${{ env.iso_path }}"
          
          echo "====================================="
          echo "Starting QEMU smoke test"
          echo "====================================="
          
          # Create serial output log
          SERIAL_LOG=$(mktemp)
          echo "Serial log: $SERIAL_LOG"
          
          # Start QEMU with headless mode and serial console
          # Using virtio for network and disk, 2GB RAM, 2 CPUs
          # Note: -nographic implies -serial stdio, don't add explicit -serial
          qemu-system-x86_64 \
            -name clawgress-smoke-test \
            -m 2048 \
            -smp 2 \
            -boot d \
            -cdrom "$ISO_PATH" \
            -nographic \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -device virtio-net-pci,netdev=net0 \
            -drive file=/dev/null,format=raw,if=virtio \
            > "$SERIAL_LOG" 2>&1 &
          
          QEMU_PID=$!
          echo "QEMU PID: $QEMU_PID"
          
          # Wait for VM to boot (look for login prompt or key indicators)
          echo "Waiting for VM to boot (timeout: 5 minutes)..."
          BOOT_TIMEOUT=300
          ELAPSED=0
          BOOT_COMPLETE=false
          
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            sleep 5
            ELAPSED=$((ELAPSED + 5))
            
            if grep -q "login:" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "vyos@" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "Welcome to VyOS" "$SERIAL_LOG" 2>/dev/null; then
              echo "✓ Boot completed (login prompt detected)"
              BOOT_COMPLETE=true
              break
            fi
            
            if ! kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ QEMU process exited early"
              break
            fi
          done
          
          if [ "$BOOT_COMPLETE" != "true" ]; then
            if kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ Boot prompt not detected within timeout, but QEMU is still running. Proceeding with smoke tests."
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              BOOT_COMPLETE=true
            else
              echo "❌ ERROR: Boot did not complete within timeout"
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              kill $QEMU_PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          echo ""
          echo "====================================="
          echo "Running smoke tests"
          echo "====================================="
          
          # Give VM a moment to fully initialize
          sleep 5
          
          TESTS_PASSED=0
          TESTS_FAILED=0
          
          # Test 1: Check boot log for version info
          echo ""
          echo "Test 1: Checking version info in boot log..."
          if grep -iE "(vyos|version|1\.5|clawgress)" "$SERIAL_LOG" > /dev/null; then
            echo "  ✓ Version info found in boot log"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "  ⚠ Version info not clearly visible in boot log (non-fatal)"
          fi
          
          # Mount the ISO to inspect its contents
          echo ""
          echo "Test 2: Checking ISO contents for bind9 package..."
          MOUNT_DIR=$(mktemp -d)
          sudo mount -o loop "$ISO_PATH" "$MOUNT_DIR" || {
            echo "  ⚠ Could not mount ISO for inspection"
          }
          
          if [ -d "$MOUNT_DIR" ] && mountpoint -q "$MOUNT_DIR"; then
            # Look for bind9 in the squashfs or package lists
            if find "$MOUNT_DIR" -name "*.squashfs" -o -name "*.packages" 2>/dev/null | head -1 | grep -q .; then
              echo "  ✓ Found squashfs/packages in ISO"
              TESTS_PASSED=$((TESTS_PASSED + 1))
            else
              echo "  ⚠ Could not locate package files in ISO"
            fi
            
            # Check for clawgress-specific files
            echo ""
            echo "Test 3: Checking for clawgress files..."
            
            # Try to extract and inspect the filesystem
            SQUASHFS=$(find "$MOUNT_DIR" -name "*.squashfs" | head -1)
            if [ -n "$SQUASHFS" ]; then
              EXTRACT_DIR=$(mktemp -d)
              sudo unsquashfs -f -d "$EXTRACT_DIR" "$SQUASHFS" 2>/dev/null || true
              
              if [ -f "$EXTRACT_DIR/config/clawgress/policy.json" ]; then
                echo "  ✓ clawgress policy.json exists"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress policy.json NOT found"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi
              
              if [ -f "$EXTRACT_DIR/usr/share/vyos/config.boot.default" ] || \
                 [ -f "$EXTRACT_DIR/opt/vyatta/etc/config.boot.default" ]; then
                echo "  ✓ VyOS config files present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              fi
              
              # Check for bind9 package
              if [ -f "$EXTRACT_DIR/var/lib/dpkg/status" ]; then
                if grep -q "^Package: bind9" "$EXTRACT_DIR/var/lib/dpkg/status"; then
                  echo "  ✓ bind9 package is installed"
                  TESTS_PASSED=$((TESTS_PASSED + 1))
                else
                  echo "  ✗ bind9 package NOT found"
                  TESTS_FAILED=$((TESTS_FAILED + 1))
                fi
              elif [ -d "$EXTRACT_DIR/usr/sbin" ] && [ -f "$EXTRACT_DIR/usr/sbin/named" ]; then
                echo "  ✓ named binary found (bind9 installed)"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ⚠ bind9 package status could not be verified"
              fi
              
              # Cleanup
              sudo rm -rf "$EXTRACT_DIR" 2>/dev/null || true
            fi
            
            sudo umount "$MOUNT_DIR" 2>/dev/null || true
          fi
          
          rmdir "$MOUNT_DIR" 2>/dev/null || true
          
          # Stop QEMU
          echo ""
          echo "Shutting down QEMU..."
          kill $QEMU_PID 2>/dev/null || true
          wait $QEMU_PID 2>/dev/null || true
          
          # Cleanup
          rm -f "$SERIAL_LOG"
          
          # Report results
          echo ""
          echo "====================================="
          echo "SMOKE TEST RESULTS"
          echo "====================================="
          echo "Tests Passed: $TESTS_PASSED"
          echo "Tests Failed: $TESTS_FAILED"
          echo ""
          
          if [ $TESTS_FAILED -gt 0 ]; then
            echo "❌ SMOKE TEST FAILED"
            exit 1
          else
            echo "✅ SMOKE TEST PASSED"
            exit 0
          fi

      - name: Upload smoke test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            /tmp/serial-*
            ./artifacts

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - build
      - smoke-test
    if: github.event_name == 'workflow_dispatch' && inputs.publish_release
    steps:
      - name: Validate release tag
        run: |
          if [ -z "${{ inputs.release_tag }}" ]; then
            echo "release_tag is required when publish_release=true"
            exit 1
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./release-assets

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: Clawgress ISO ${{ needs.build.outputs.iso_version }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ./release-assets/*.iso
            ./release-assets/SHA256SUMS
