name: Build Clawgress Images

on:
  workflow_dispatch:
  push:
    branches: [ main, current ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout clawgress (vyos-1x fork)
        uses: actions/checkout@v4
        with:
          path: vyos-1x

      - name: Configure Debian bookworm repo for newer live-build
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y gnupg ca-certificates && break || sleep 10; done
          sudo mkdir -p /usr/share/keyrings
          curl -fsSL https://ftp-master.debian.org/keys/archive-key-12.asc | sudo gpg --dearmor -o /usr/share/keyrings/debian-archive-keyring.gpg
          sudo tee /etc/apt/sources.list.d/debian-bookworm.list <<'EOF'
          deb [signed-by=/usr/share/keyrings/debian-archive-keyring.gpg] http://deb.debian.org/debian bookworm main
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm <<'EOF'
          Package: *
          Pin: release n=bookworm
          Pin-Priority: 100
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm-live-build <<'EOF'
          Package: live-build
          Pin: release n=bookworm
          Pin-Priority: 990
          EOF

      - name: Install build dependencies
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y \
            git make curl sudo \
            build-essential \
            pbuilder devscripts equivs lsb-release libtool libapt-pkg-dev pkg-config debhelper \
            qemu-utils \
            python3 python3-venv python3-distutils \
            python3.11 python3.11-venv python3.11-dev \
            python3-pip python3-jinja2 python3-pystache python3-tomli python3-tomli-w python3-git \
            libcrack2-dev \
            fakechroot \
            squashfs-tools genisoimage \
            gdisk sbsigntool dosfstools kpartx \
            cpio \
            syslinux grub2 grub-pc grub2-common \
            parted udev && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y -t bookworm debootstrap live-build && break || sleep 10; done

      - name: Use Python 3.11
        run: |
          sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
          python3 --version
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade psutil

      - name: Install cracklib for Python 3.11
        run: |
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade --force-reinstall --no-binary :all: cracklib

      - name: Clone vyos-build
        run: |
          git clone https://github.com/vyos/vyos-build.git

      - name: Copy vyos-build modifications
        run: |
          # Copy build.conf to vyos-build
          cp vyos-1x/vyos-build-modifications/build.conf vyos-build/build.conf
          
          # Copy chroot hook for bind9
          mkdir -p vyos-build/data/live-build-config/hooks/live/
          cp vyos-1x/vyos-build-modifications/50-clawgress-bind9.chroot vyos-build/data/live-build-config/hooks/live/
          chmod +x vyos-build/data/live-build-config/hooks/live/50-clawgress-bind9.chroot
          
          # Copy policy.json to includes.chroot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          cp vyos-1x/vyos-build-modifications/config/clawgress/policy.json vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          
          echo "I: vyos-build modifications copied successfully"
          ls -la vyos-build/data/live-build-config/hooks/live/
          ls -la vyos-build/data/live-build-config/includes.chroot/config/clawgress/

      - name: Build vyos-1x package
        run: |
          cd vyos-1x
          # Build the Debian package
          sudo apt-get build-dep -y .
          dpkg-buildpackage -uc -us -b -nc
          cd ..
          # Show built packages
          echo "I: Built packages:"
          ls -la *.deb

      - name: Configure build
        run: |
          cd vyos-build
          # Update build.conf to point to the workspace as the package source
          # The vyos-build system will look for .deb packages in the parent directory
          echo "VYOS_SOURCE=${{ github.workspace }}" >> build.conf
          cat build.conf

      - name: Build ISO
        run: |
          cd vyos-build
          # Build with local vyos-1x source (packages will be picked up from VYOS_SOURCE)
          sudo ./build-vyos-image --build-by github-actions --architecture amd64 --build-type release --version clawgress generic

      - name: Build OVA (if supported)
        run: |
          cd vyos-build
          # OVA requires ISO first, then conversion
          if [ -f build/*.iso ]; then
            echo "OVA build would require additional tools (ovftool, etc.)"
            echo "Skipping OVA for now - ISO is the primary artifact"
          fi
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clawgress-images
          path: |
            vyos-build/build/*.iso
            vyos-build/build/*.ova
