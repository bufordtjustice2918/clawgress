name: Build Clawgress Images

on:
  workflow_dispatch:
    inputs:
      iso_version:
        description: ISO version label passed to build-vyos-image
        required: true
        default: clawgress-mvpv2
      publish_release:
        description: Publish ISO + checksums as a GitHub release
        required: true
        default: false
        type: boolean
      release_tag:
        description: Git tag for release (required if publish_release=true)
        required: false
        default: ""
  schedule:
    # Nightly build at 2 AM UTC to track VyOS upstream
    - cron: '0 2 * * *'
  # push trigger disabled; use workflow_dispatch only

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    outputs:
      artifact_name: ${{ steps.artifact_meta.outputs.artifact_name }}
      iso_version: ${{ steps.iso_version.outputs.iso_version }}
    steps:
      - name: Checkout clawgress (vyos-1x fork)
        uses: actions/checkout@v4
        with:
          path: vyos-1x

      - name: Resolve ISO version
        id: iso_version
        run: |
          if [ -n "${{ inputs.iso_version }}" ]; then
            echo "iso_version=${{ inputs.iso_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "iso_version=clawgress-nightly-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure Debian bookworm repo for newer live-build
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y gnupg ca-certificates && break || sleep 10; done
          sudo mkdir -p /usr/share/keyrings
          curl -fsSL https://ftp-master.debian.org/keys/archive-key-12.asc | sudo gpg --dearmor -o /usr/share/keyrings/debian-archive-keyring.gpg
          sudo tee /etc/apt/sources.list.d/debian-bookworm.list <<'EOF'
          deb [signed-by=/usr/share/keyrings/debian-archive-keyring.gpg] http://deb.debian.org/debian bookworm main
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm <<'EOF'
          Package: *
          Pin: release n=bookworm
          Pin-Priority: 100
          EOF
          sudo tee /etc/apt/preferences.d/debian-bookworm-live-build <<'EOF'
          Package: live-build
          Pin: release n=bookworm
          Pin-Priority: 990
          EOF

      - name: Install build dependencies
        run: |
          for i in 1 2 3 4 5; do sudo apt-get update && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y \
            git make curl sudo \
            build-essential \
            pbuilder devscripts equivs lsb-release libtool libapt-pkg-dev pkg-config debhelper \
            opam ocaml ocaml-findlib \
            qemu-utils \
            python3 python3-venv python3-distutils \
            python3.11 python3.11-venv python3.11-dev \
            python3-pip python3-jinja2 python3-pystache python3-tomli python3-tomli-w python3-git \
            libcrack2-dev \
            fakechroot \
            squashfs-tools genisoimage \
            gdisk sbsigntool dosfstools kpartx \
            cpio \
            syslinux grub2 grub-pc grub2-common \
            parted udev && break || sleep 10; done
          for i in 1 2 3 4 5; do sudo apt-get install -y -t bookworm debootstrap live-build && break || sleep 10; done

      - name: Use Python 3.11
        run: |
          sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
          python3 --version
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade psutil lxml xmltodict

      - name: Install cracklib for Python 3.11
        run: |
          sudo python3.11 -m pip install --upgrade pip
          sudo python3.11 -m pip install --upgrade --force-reinstall --no-binary :all: cracklib

      - name: Clone vyos-build
        run: |
          git clone https://github.com/vyos/vyos-build.git

      - name: Generate Clawgress CLI templates from XML
        run: |
          set -euo pipefail
          cd vyos-1x
          GEN_ROOT=/tmp/clawgress-cli-gen
          rm -rf "${GEN_ROOT}"
          mkdir -p "${GEN_ROOT}/build/interface-definitions" "${GEN_ROOT}/build/op-mode-definitions" "${GEN_ROOT}/templates-cfg" "${GEN_ROOT}/templates-op"
          ./scripts/transclude-template interface-definitions/service_clawgress.xml.in > "${GEN_ROOT}/build/interface-definitions/service_clawgress.xml"
          ./scripts/transclude-template op-mode-definitions/show-clawgress.xml.in > "${GEN_ROOT}/build/op-mode-definitions/show-clawgress.xml"
          ./scripts/build-command-templates "${GEN_ROOT}/build/interface-definitions/service_clawgress.xml" schema/interface_definition.rng "${GEN_ROOT}/templates-cfg"
          ./scripts/build-command-op-templates "${GEN_ROOT}/build/op-mode-definitions/show-clawgress.xml" schema/op-mode-definition.rng "${GEN_ROOT}/templates-op"
          test -d "${GEN_ROOT}/templates-cfg/service/clawgress"
          test -d "${GEN_ROOT}/templates-op/show/clawgress"

      - name: Copy vyos-build modifications
        run: |
          set -euo pipefail
          # Fail fast on required files and use explicit workspace paths.
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/build.conf"
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/50-clawgress-bind9.chroot"
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/60-clawgress-init.chroot"
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/00-clawgress-dash-divert.chroot"
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot"
          test -f "${{ github.workspace }}/vyos-1x/vyos-build-modifications/config/clawgress/policy.json"
          test -f "${{ github.workspace }}/vyos-1x/src/op_mode/clawgress.py"
          test -f "${{ github.workspace }}/vyos-1x/src/conf_mode/clawgress.py"
          test -f "${{ github.workspace }}/vyos-1x/src/helpers/clawgress-policy-apply.py"
          test -f "${{ github.workspace }}/vyos-1x/src/helpers/clawgress-firewall-apply.py"
          test -f "${{ github.workspace }}/vyos-1x/src/utils/clawgress-policy-apply"
          test -f "${{ github.workspace }}/vyos-1x/src/utils/clawgress-firewall-apply"
          test -f "${{ github.workspace }}/vyos-1x/src/utils/clawgress"
          test -f "${{ github.workspace }}/vyos-1x/interface-definitions/service_clawgress.xml.in"
          test -f "${{ github.workspace }}/vyos-1x/op-mode-definitions/show-clawgress.xml.in"

          # Copy build.conf to vyos-build
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/build.conf" vyos-build/build.conf
          
          # Copy build flavor overrides (qcow2)
          mkdir -p vyos-build/data/build-flavors/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/build-flavors/qcow2.toml" vyos-build/data/build-flavors/

          # Copy chroot hooks
          mkdir -p vyos-build/data/live-build-config/hooks/live/
          mkdir -p vyos-build/data/live-build-config/hooks/chroot/
          mkdir -p vyos-build/data/live-build-config/hooks/normal/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/50-clawgress-bind9.chroot" vyos-build/data/live-build-config/hooks/live/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/60-clawgress-init.chroot" vyos-build/data/live-build-config/hooks/live/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/00-clawgress-dash-divert.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/00-clawgress-dash-divert.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/chroot/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/normal/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/99-clawgress-force-bash.chroot" vyos-build/data/live-build-config/hooks/live/
          chmod +x vyos-build/data/live-build-config/hooks/live/50-clawgress-bind9.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/60-clawgress-init.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/00-clawgress-dash-divert.chroot
          chmod +x vyos-build/data/live-build-config/hooks/chroot/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/normal/99-clawgress-force-bash.chroot
          chmod +x vyos-build/data/live-build-config/hooks/live/99-clawgress-force-bash.chroot
          
          # Copy policy.json to includes.chroot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/config/clawgress/policy.json" vyos-build/data/live-build-config/includes.chroot/config/clawgress/
          # Also store default policy in /usr/share/clawgress for seeding /config on boot
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/
          cp "${{ github.workspace }}/vyos-1x/vyos-build-modifications/config/clawgress/policy.json" vyos-build/data/live-build-config/includes.chroot/usr/share/clawgress/policy.json

          # Copy Clawgress Python handlers + helper scripts into image.
          # Also copy XML definitions to ensure MVP CLI/op-mode definitions are present.
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/bin/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op-mode-definitions/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/interface-definitions/
          cp "${{ github.workspace }}/vyos-1x/src/op_mode/clawgress.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/
          cp "${{ github.workspace }}/vyos-1x/src/helpers/clawgress-policy-apply.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          cp "${{ github.workspace }}/vyos-1x/src/helpers/clawgress-firewall-apply.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/
          # Config-mode handler
          mkdir -p vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp "${{ github.workspace }}/vyos-1x/src/conf_mode/clawgress.py" vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/
          cp "${{ github.workspace }}/vyos-1x/src/utils/clawgress-policy-apply" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${{ github.workspace }}/vyos-1x/src/utils/clawgress-firewall-apply" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${{ github.workspace }}/vyos-1x/src/utils/clawgress" vyos-build/data/live-build-config/includes.chroot/usr/bin/
          cp "${{ github.workspace }}/vyos-1x/op-mode-definitions/show-clawgress.xml.in" vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/op-mode-definitions/show-clawgress.xml.in
          cp "${{ github.workspace }}/vyos-1x/interface-definitions/service_clawgress.xml.in" vyos-build/data/live-build-config/includes.chroot/usr/share/vyos/interface-definitions/service_clawgress.xml.in
          # Copy generated command templates + reftree cache so CLI nodes are actually available at runtime.
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/
          mkdir -p vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/
          cp -a "/tmp/clawgress-cli-gen/templates-cfg/service/clawgress" vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-cfg/templates/service/
          cp -a "/tmp/clawgress-cli-gen/templates-op/show/clawgress" vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/show/
          if [ -d "/tmp/clawgress-cli-gen/templates-op/clawgress" ]; then
            cp -a "/tmp/clawgress-cli-gen/templates-op/clawgress" vyos-build/data/live-build-config/includes.chroot/opt/vyatta/share/vyatta-op/templates/
          fi
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/op_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/conf_mode/clawgress.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-policy-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/libexec/vyos/clawgress-firewall-apply.py
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-policy-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress-firewall-apply
          chmod +x vyos-build/data/live-build-config/includes.chroot/usr/bin/clawgress
          
          echo "I: vyos-build modifications copied successfully"
          ls -la vyos-build/data/live-build-config/hooks/live/
          ls -la vyos-build/data/live-build-config/includes.chroot/config/clawgress/

      - name: Configure build
        run: |
          cd vyos-build
          # Point VYOS_SOURCE to the vyos-1x source tree
          # The build system will use this directly (no need to build .deb first)
          echo "VYOS_SOURCE=${{ github.workspace }}/vyos-1x" >> build.conf
          cat build.conf

      - name: Build ISO
        run: |
          cd vyos-build
          # Build with local vyos-1x source (packages will be picked up from VYOS_SOURCE)
          sudo ./build-vyos-image --build-by github-actions --architecture amd64 --build-type release --version "${{ steps.iso_version.outputs.iso_version }}" generic
          ISO_FILE=$(ls -t build/*.iso | head -1)
          if [ -n "$ISO_FILE" ] && [ "$(basename "$ISO_FILE")" != "vyos-clawgress-generic-amd64.iso" ]; then
            sudo ln -sf "$(basename "$ISO_FILE")" build/vyos-clawgress-generic-amd64.iso
          fi

      - name: Remove live-build ISO
        run: |
          sudo rm -f vyos-build/build/live-image-*.iso

      - name: Generate checksums
        run: |
          cd vyos-build/build
          sudo sh -c 'sha256sum *.iso > SHA256SUMS'

      - name: Compute artifact metadata
        id: artifact_meta
        run: |
          echo "artifact_name=clawgress-images-${{ steps.iso_version.outputs.iso_version }}-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_meta.outputs.artifact_name }}
          path: |
            vyos-build/build/*.iso
            vyos-build/build/SHA256SUMS
          retention-days: 7

  smoke-test:
    name: Smoke Test ISO
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./artifacts

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils

      - name: Find ISO and verify
        run: |
          ISO_PATH=$(find ./artifacts -name "*.iso" -type f | head -1)
          if [ -z "$ISO_PATH" ]; then
            echo "❌ ERROR: No ISO file found in artifacts"
            exit 1
          fi
          echo "iso_path=$ISO_PATH" >> $GITHUB_ENV
          echo "ISO found: $ISO_PATH"
          ls -lh "$ISO_PATH"

      - name: Boot ISO in QEMU and run smoke tests
        run: |
          set -e
          ISO_PATH="${{ env.iso_path }}"
          
          echo "====================================="
          echo "Starting QEMU smoke test"
          echo "====================================="
          
          # Create serial output log
          SERIAL_LOG=$(mktemp)
          echo "Serial log: $SERIAL_LOG"
          
          # Start QEMU with headless mode and serial console
          # Using virtio for network and disk, 2GB RAM, 2 CPUs
          # Note: -nographic implies -serial stdio, don't add explicit -serial
          qemu-system-x86_64 \
            -name clawgress-smoke-test \
            -m 2048 \
            -smp 2 \
            -boot d \
            -cdrom "$ISO_PATH" \
            -nographic \
            -netdev user,id=net0,hostfwd=tcp::2222-:22 \
            -device virtio-net-pci,netdev=net0 \
            -drive file=/dev/null,format=raw,if=virtio \
            > "$SERIAL_LOG" 2>&1 &
          
          QEMU_PID=$!
          echo "QEMU PID: $QEMU_PID"
          
          # Wait for VM to boot (look for login prompt or key indicators)
          echo "Waiting for VM to boot (timeout: 5 minutes)..."
          BOOT_TIMEOUT=300
          ELAPSED=0
          BOOT_COMPLETE=false
          
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            sleep 5
            ELAPSED=$((ELAPSED + 5))
            
            if grep -q "login:" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "vyos@" "$SERIAL_LOG" 2>/dev/null || \
               grep -q "Welcome to VyOS" "$SERIAL_LOG" 2>/dev/null; then
              echo "✓ Boot completed (login prompt detected)"
              BOOT_COMPLETE=true
              break
            fi
            
            if ! kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ QEMU process exited early"
              break
            fi
          done
          
          if [ "$BOOT_COMPLETE" != "true" ]; then
            if kill -0 $QEMU_PID 2>/dev/null; then
              echo "⚠ Boot prompt not detected within timeout, but QEMU is still running. Proceeding with smoke tests."
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              BOOT_COMPLETE=true
            else
              echo "❌ ERROR: Boot did not complete within timeout"
              echo "=== Last 50 lines of serial output ==="
              tail -50 "$SERIAL_LOG" || true
              kill $QEMU_PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          echo ""
          echo "====================================="
          echo "Running smoke tests"
          echo "====================================="
          
          # Give VM a moment to fully initialize
          sleep 5
          
          TESTS_PASSED=0
          TESTS_FAILED=0
          
          # Test 1: Check boot log for version info
          echo ""
          echo "Test 1: Checking version info in boot log..."
          if grep -iE "(vyos|version|1\.5|clawgress)" "$SERIAL_LOG" > /dev/null; then
            echo "  ✓ Version info found in boot log"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "  ⚠ Version info not clearly visible in boot log (non-fatal)"
          fi
          
          # Mount the ISO to inspect its contents
          echo ""
          echo "Test 2: Checking ISO contents for bind9 package..."
          MOUNT_DIR=$(mktemp -d)
          sudo mount -o loop "$ISO_PATH" "$MOUNT_DIR" || {
            echo "  ⚠ Could not mount ISO for inspection"
          }
          
          if [ -d "$MOUNT_DIR" ] && mountpoint -q "$MOUNT_DIR"; then
            # Look for bind9 in the squashfs or package lists
            if find "$MOUNT_DIR" -name "*.squashfs" -o -name "*.packages" 2>/dev/null | head -1 | grep -q .; then
              echo "  ✓ Found squashfs/packages in ISO"
              TESTS_PASSED=$((TESTS_PASSED + 1))
            else
              echo "  ⚠ Could not locate package files in ISO"
            fi
            
            # Check for clawgress-specific files
            echo ""
            echo "Test 3: Checking for clawgress files..."
            
            # Try to extract and inspect the filesystem
            SQUASHFS=$(find "$MOUNT_DIR" -name "*.squashfs" | head -1)
            if [ -n "$SQUASHFS" ]; then
              EXTRACT_DIR=$(mktemp -d)
              sudo unsquashfs -f -d "$EXTRACT_DIR" "$SQUASHFS" 2>/dev/null || true
              
              if [ -f "$EXTRACT_DIR/config/clawgress/policy.json" ]; then
                echo "  ✓ clawgress policy.json exists"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ✗ clawgress policy.json NOT found"
                TESTS_FAILED=$((TESTS_FAILED + 1))
              fi
              
              if [ -f "$EXTRACT_DIR/usr/share/vyos/config.boot.default" ] || \
                 [ -f "$EXTRACT_DIR/opt/vyatta/etc/config.boot.default" ]; then
                echo "  ✓ VyOS config files present"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              fi
              
              # Check for bind9 package
              if [ -f "$EXTRACT_DIR/var/lib/dpkg/status" ]; then
                if grep -q "^Package: bind9" "$EXTRACT_DIR/var/lib/dpkg/status"; then
                  echo "  ✓ bind9 package is installed"
                  TESTS_PASSED=$((TESTS_PASSED + 1))
                else
                  echo "  ✗ bind9 package NOT found"
                  TESTS_FAILED=$((TESTS_FAILED + 1))
                fi
              elif [ -d "$EXTRACT_DIR/usr/sbin" ] && [ -f "$EXTRACT_DIR/usr/sbin/named" ]; then
                echo "  ✓ named binary found (bind9 installed)"
                TESTS_PASSED=$((TESTS_PASSED + 1))
              else
                echo "  ⚠ bind9 package status could not be verified"
              fi
              
              # Cleanup
              sudo rm -rf "$EXTRACT_DIR" 2>/dev/null || true
            fi
            
            sudo umount "$MOUNT_DIR" 2>/dev/null || true
          fi
          
          rmdir "$MOUNT_DIR" 2>/dev/null || true
          
          # Stop QEMU
          echo ""
          echo "Shutting down QEMU..."
          kill $QEMU_PID 2>/dev/null || true
          wait $QEMU_PID 2>/dev/null || true
          
          # Cleanup
          rm -f "$SERIAL_LOG"
          
          # Report results
          echo ""
          echo "====================================="
          echo "SMOKE TEST RESULTS"
          echo "====================================="
          echo "Tests Passed: $TESTS_PASSED"
          echo "Tests Failed: $TESTS_FAILED"
          echo ""
          
          if [ $TESTS_FAILED -gt 0 ]; then
            echo "❌ SMOKE TEST FAILED"
            exit 1
          else
            echo "✅ SMOKE TEST PASSED"
            exit 0
          fi

      - name: Upload smoke test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            /tmp/serial-*
            ./artifacts

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - build
      - smoke-test
    if: github.event_name == 'workflow_dispatch' && inputs.publish_release
    steps:
      - name: Validate release tag
        run: |
          if [ -z "${{ inputs.release_tag }}" ]; then
            echo "release_tag is required when publish_release=true"
            exit 1
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./release-assets

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: Clawgress ISO ${{ needs.build.outputs.iso_version }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ./release-assets/*.iso
            ./release-assets/SHA256SUMS
